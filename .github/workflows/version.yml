permissions: write-all # Equivalent to default permissions plus id-token: write
name: dev-version

on:
  workflow_call:
    outputs:
      version:
        description: Calculated version
        value: ${{ jobs.version.outputs.version }}

env:
  ESC_ACTION_OIDC_AUTH: true
  ESC_ACTION_OIDC_ORGANIZATION: pulumi
  ESC_ACTION_OIDC_REQUESTED_TOKEN_TYPE: urn:pulumi:token-type:access_token:organization
  ESC_ACTION_ENVIRONMENT: imports/github-secrets
  ESC_ACTION_EXPORT_ENVIRONMENT_VARIABLES: GITHUB_TOKEN=PULUMI_BOT_TOKEN

jobs:
  version:
    runs-on: ubuntu-latest
    name: Calculate Dev Version
    steps:
      - name: Fetch secrets from ESC
        id: esc-secrets
        uses: pulumi/esc-action@v1
      - id: version
        name: Calculate build version
        uses: pulumi/provider-version-action@v1
    outputs:
      version: ${{ steps.version.outputs.VERSION }}
