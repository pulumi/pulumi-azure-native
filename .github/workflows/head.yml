name: master

on:
  push:
    branches:
      - v2
    paths-ignore:
      - CHANGELOG.md
    tags-ignore:
      - v*
      - sdk/*
      - "**"
  workflow_dispatch:

env:
  PROVIDER: azure-native
  PROVIDER_VERSION: 2.91.0-alpha.0+dev
  PULUMI_LOCAL_NUGET: ${{ github.workspace }}/nuget
  TRAVIS_OS_NAME: linux
  PULUMI_GO_DEP_ROOT: ${{ github.workspace }}/..
  ARM_LOCATION: westus2
  PULUMI_API: https://api.pulumi-staging.io
  GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

jobs:
  prerequisites:
    runs-on: ubuntu-latest
    name: Build binaries and schema
    permissions:
      id-token: write # For ESC secrets
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Languages & Frameworks
        uses: ./.github/actions/install
        with:
          skip_dotnet_and_java: "true"

      - name: Build schema and binaries
        run: make codegen schema provider

      - name: Verify schema-full.json is generated (v2 uses full schema)
        run: |
          if [ ! -f bin/schema-full.json ]; then
            echo "ERROR: schema-full.json not found! v2 should use full schema."
            exit 1
          fi
          echo "âœ“ schema-full.json generated correctly for v2"

      - name: Artifact capture
        uses: ./.github/actions/prerequisites-artifact-capture

      - name: Check worktree clean
        uses: pulumi/git-status-check-action@v1

      - if: failure() && github.event_name == 'push'
        name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          author_name: Failure in building v2 provider prerequisites
          fields: repo,commit,author,action
          status: ${{ job.status }}

  test_provider:
    runs-on: ubuntu-latest
    needs: prerequisites
    name: Test provider (unit tests only)
    permissions:
      id-token: write # For ESC secrets
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: true

      - name: Install Languages & Frameworks
        uses: ./.github/actions/install
        with:
          skip_dotnet_and_java: "true"

      - run: make ensure

      - name: Prerequisites artifact restore
        uses: ./.github/actions/prerequisites-artifact-restore

      - name: Run provider unit tests
        run: make test_provider PROVIDER_TEST_TAGS=unit

      - if: failure() && github.event_name == 'push'
        name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          author_name: Failure in v2 provider unit tests
          fields: repo,commit,author,action
          status: ${{ job.status }}
