name: publish

on:
  workflow_call:
    inputs:
      ref:
        required: true
        type: string
      version:
        required: true
        type: string
        description: Version to be used to publish the SDKs
      prerelease:
        required: true
        type: boolean
        description: Indicates if we're doing a pre- or proper release.
      publishGhRelease:
        type: boolean
        description: Indicates if we're publishing a GitHub release.
        default: true

env:
  PROVIDER: azure-native
  PROVIDER_VERSION: ${{ inputs.version }}
  PULUMI_LOCAL_NUGET: ${{ github.workspace }}/nuget
  TRAVIS_OS_NAME: linux
  PULUMI_GO_DEP_ROOT: ${{ github.workspace }}/..
  ARM_LOCATION: westus2
  PULUMI_API: https://api.pulumi-staging.io

jobs:
  publish-provider:
    runs-on: ubuntu-latest
    name: publish-provider
    permissions:
      id-token: write # For ESC secrets.
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: true
          ref: ${{ inputs.ref }}

      - name: Free Disk Space (Ubuntu)
        uses: jlumbroso/free-disk-space@54081f138730dfa15788a46383842cd2f914a1be # v1.3.1
        with:
          tool-cache: false
          swap-storage: false
          dotnet: false

      - env:
          ESC_ACTION_ENVIRONMENT: github-secrets/${{ github.repository_owner }}-${{ github.event.repository.name }}
          ESC_ACTION_OIDC_AUTH: "true"
          ESC_ACTION_OIDC_ORGANIZATION: pulumi
          ESC_ACTION_OIDC_REQUESTED_TOKEN_TYPE: urn:pulumi:token-type:access_token:organization
        id: esc-secrets
        name: Fetch secrets from ESC
        uses: pulumi/esc-action@9eb774255b1a4afb7855678ae8d4a77359da0d9b

      - name: Install Languages & Frameworks
        uses: ./.github/actions/install
        with:
          skip_dotnet_and_java: "true"

      - run: make ensure

      - name: Prerequisites artifact restore
        uses: ./.github/actions/prerequisites-artifact-restore

      - name: Ensure provider build prerequisites
        run: |
          make prebuild
          # Don't include provider as that's the bit we're going to rebuild
          make --touch codegen schema
          make provider_prebuild

      - name: Build dist packages
        run: make dist --jobs=2

      - name: Install Schema Tools
        uses: jaxxstorm/action-install-gh-release@v1.11.0
        with:
          repo: pulumi/schema-tools

      - name: Get Schema Change Summary
        id: schema-summary
        shell: bash
        run: |
          # v2 branch: find previous v2 release (not the overall latest which is v3)
          LAST_VERSION=$(gh release list --repo pulumi/pulumi-azure-native --limit 100 \
            | grep -E "^v2\.[0-9]+\.[0-9]+\s" \
            | grep -v "v${{ inputs.version }}" \
            | head -1 \
            | awk '{print $1}')

          if [ -z "$LAST_VERSION" ]; then
            echo "No previous v2 release found, skipping schema comparison"
            echo "summary=No previous v2 release found for comparison." >> "$GITHUB_OUTPUT"
            exit 0
          fi

          echo "Comparing against previous v2 release: $LAST_VERSION"
          {
            echo 'summary<<EOF'
            schema-tools compare --provider="azure-native" --old-commit="$LAST_VERSION" --new-commit="--local-path=provider/cmd/pulumi-resource-azure-native/schema.json"
            echo 'EOF'
          } >> "$GITHUB_OUTPUT"
        env:
          GITHUB_TOKEN: ${{ steps.esc-secrets.outputs.PULUMI_BOT_TOKEN }}

      - name: Configure AWS Credentials
        # https://github.com/aws-actions/configure-aws-credentials#notice-node12-deprecation-warning
        uses: aws-actions/configure-aws-credentials@v1-node16
        with:
          aws-access-key-id: ${{ steps.esc-secrets.outputs.AWS_ACCESS_KEY_ID }}
          aws-region: us-east-2
          aws-secret-access-key: ${{ steps.esc-secrets.outputs.AWS_SECRET_ACCESS_KEY }}
          role-duration-seconds: 7200
          role-session-name: ${{ env.PROVIDER }}@githubActions
          role-external-id: upload-pulumi-release
          role-to-assume: ${{ steps.esc-secrets.outputs.AWS_UPLOAD_ROLE_ARN }}

      - name: Upload Provider Binaries
        run: aws s3 cp dist s3://get.pulumi.com/releases/plugins/ --recursive

      - name: Create GH Release
        # Pin to v2.4.2 to avoid bug in v2.5.0 where make_latest is not passed during finalizeRelease
        # See: https://github.com/softprops/action-gh-release/pull/692
        uses: softprops/action-gh-release@v2.4.2
        if: inputs.publishGhRelease
        with:
          tag_name: v${{ inputs.version }}
          prerelease: ${{ inputs.prerelease }}
          # We keep pre-releases as drafts so they're not visible until we manually publish them.
          draft: ${{ inputs.prerelease }}
          body: ${{ steps.schema-summary.outputs.summary }}
          generate_release_notes: true
          files: dist/*
          # v2 maintenance branch: never mark as latest release
          make_latest: false
        env:
          GITHUB_TOKEN: ${{ steps.esc-secrets.outputs.PULUMI_BOT_TOKEN }}

      - if: failure() && github.event_name == 'push'
        name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          author_name: Failure in publishing binaries
          fields: repo,commit,author,action
          status: ${{ job.status }}

  publish-python-sdk:
    runs-on: ubuntu-latest
    name: publish-python-sdk
    needs: publish-provider
    permissions:
      id-token: write # For ESC secrets.
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: true

      - env:
          ESC_ACTION_ENVIRONMENT: github-secrets/${{ github.repository_owner }}-${{ github.event.repository.name }}
          ESC_ACTION_OIDC_AUTH: "true"
          ESC_ACTION_OIDC_ORGANIZATION: pulumi
          ESC_ACTION_OIDC_REQUESTED_TOKEN_TYPE: urn:pulumi:token-type:access_token:organization
        id: esc-secrets
        name: Fetch secrets from ESC
        uses: pulumi/esc-action@9eb774255b1a4afb7855678ae8d4a77359da0d9b

      - name: Install Languages & Frameworks
        uses: ./.github/actions/install

      - name: Download python SDK
        uses: actions/download-artifact@v4
        with:
          name: python-sdk.tar.gz
          path: ${{ github.workspace}}/sdk/

      - name: Uncompress python SDK
        run: tar -zxf ${{github.workspace}}/sdk/python.tar.gz -C
          ${{github.workspace}}/sdk/python

      - name: Install Twine
        run: python -m pip install pip twine

      - name: Publish PyPi Package
        run: >
          twine upload
          -u "__token__"
          -p "${{ steps.esc-secrets.outputs.PYPI_API_TOKEN }}"
          "${{ github.workspace }}/sdk/python/bin/dist/*"
          --skip-existing
          --verbose

      - if: failure() && github.event_name == 'push'
        name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          author_name: Failure in publishing Python SDK
          fields: repo,commit,author,action
          status: ${{ job.status }}

  publish-dotnet-sdk:
    runs-on: ubuntu-latest
    name: publish-dotnet-sdk
    needs: publish-provider
    permissions:
      id-token: write # For ESC secrets.
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: true

      - env:
          ESC_ACTION_ENVIRONMENT: github-secrets/${{ github.repository_owner }}-${{ github.event.repository.name }}
          ESC_ACTION_OIDC_AUTH: "true"
          ESC_ACTION_OIDC_ORGANIZATION: pulumi
          ESC_ACTION_OIDC_REQUESTED_TOKEN_TYPE: urn:pulumi:token-type:access_token:organization
        id: esc-secrets
        name: Fetch secrets from ESC
        uses: pulumi/esc-action@9eb774255b1a4afb7855678ae8d4a77359da0d9b

      - name: Checkout Scripts Repo
        uses: actions/checkout@v4
        with:
          path: ci-scripts
          repository: pulumi/scripts

      - name: Install Languages & Frameworks
        uses: ./.github/actions/install

      - name: Download dotnet SDK
        uses: actions/download-artifact@v4
        with:
          name: dotnet-sdk.tar.gz
          path: ${{ github.workspace}}/sdk/

      - name: Uncompress dotnet SDK
        run: tar -zxf ${{github.workspace}}/sdk/dotnet.tar.gz -C
          ${{github.workspace}}/sdk/dotnet

      - name: Publish NuGet Package
        run: |
          find "sdk/dotnet/bin/Debug/" -name 'Pulumi.*.nupkg' \
            -exec dotnet nuget push -k "${{ steps.esc-secrets.outputs.NUGET_PUBLISH_KEY }}" -s https://api.nuget.org/v3/index.json {} ';'

      - if: failure() && github.event_name == 'push'
        name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          author_name: Failure in publishing dotnet SDK
          fields: repo,commit,author,action
          status: ${{ job.status }}

  publish-nodejs-sdk:
    runs-on: ubuntu-latest
    name: publish-nodejs-sdk
    needs: publish-provider
    permissions:
      id-token: write # For ESC secrets.
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: true

      - env:
          ESC_ACTION_ENVIRONMENT: github-secrets/${{ github.repository_owner }}-${{ github.event.repository.name }}
          ESC_ACTION_OIDC_AUTH: "true"
          ESC_ACTION_OIDC_ORGANIZATION: pulumi
          ESC_ACTION_OIDC_REQUESTED_TOKEN_TYPE: urn:pulumi:token-type:access_token:organization
        id: esc-secrets
        name: Fetch secrets from ESC
        uses: pulumi/esc-action@9eb774255b1a4afb7855678ae8d4a77359da0d9b

      - name: Install Languages & Frameworks
        uses: ./.github/actions/install

      - name: Download nodejs SDK
        uses: actions/download-artifact@v4
        with:
          name: nodejs-sdk.tar.gz
          path: ${{ github.workspace}}/sdk/

      - name: Uncompress nodejs SDK
        run: tar -zxf ${{github.workspace}}/sdk/nodejs.tar.gz -C
          ${{github.workspace}}/sdk/nodejs

      - name: Publish Node.JS SDK
        working-directory: sdk/nodejs/bin
        # v2 maintenance branch: use latest-v2 tag to avoid overwriting 'latest' (which is v3)
        run: npm publish --tag latest-v2
        env:
          NODE_AUTH_TOKEN: ${{ steps.esc-secrets.outputs.NPM_TOKEN }}

      - if: failure() && github.event_name == 'push'
        name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          author_name: Failure in publishing SDK
          fields: repo,commit,author,action
          status: ${{ job.status }}

  publish-java-sdk:
    runs-on: ubuntu-latest
    name: publish-java-sdk
    needs: publish-provider
    env:
      PACKAGE_VERSION: ${{ inputs.version }}
    permissions:
      id-token: write # For ESC secrets.
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: true

      - env:
          ESC_ACTION_ENVIRONMENT: github-secrets/${{ github.repository_owner }}-${{ github.event.repository.name }}
          ESC_ACTION_OIDC_AUTH: "true"
          ESC_ACTION_OIDC_ORGANIZATION: pulumi
          ESC_ACTION_OIDC_REQUESTED_TOKEN_TYPE: urn:pulumi:token-type:access_token:organization
        id: esc-secrets
        name: Fetch secrets from ESC
        uses: pulumi/esc-action@9eb774255b1a4afb7855678ae8d4a77359da0d9b

      - name: Install Languages & Frameworks
        uses: ./.github/actions/install

      - name: Download java SDK
        uses: actions/download-artifact@v4
        with:
          name: java-sdk.tar.gz
          path: ${{ github.workspace}}/sdk/

      - name: Uncompress java SDK
        run: tar -zxf ${{github.workspace}}/sdk/java.tar.gz -C
          ${{github.workspace}}/sdk/java

      - name: Setup Gradle
        if: inputs.prerelease == false
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: 8.13

      - name: Publish Java SDK
        # Maven doesn't use lock files and version ranges can't exclude prereleases.
        # Therefore we can't publish prereleases without risking breaking customers.
        # All other ecosystems handle prereleases correctly, Maven is the exception.
        if: inputs.prerelease == false
        run: gradle -p ./sdk/java publishToSonatype closeAndReleaseSonatypeStagingRepository
        env:
          PACKAGE_VERSION: ${{ env.PROVIDER_VERSION }}
          SIGNING_KEY_ID: ${{ steps.esc-secrets.outputs.JAVA_SIGNING_KEY_ID }}
          SIGNING_KEY: ${{ steps.esc-secrets.outputs.JAVA_SIGNING_KEY }}
          SIGNING_PASSWORD: ${{ steps.esc-secrets.outputs.JAVA_SIGNING_PASSWORD }}
          PUBLISH_REPO_PASSWORD: ${{ steps.esc-secrets.outputs.OSSRH_PASSWORD }}
          PUBLISH_REPO_USERNAME: ${{ steps.esc-secrets.outputs.OSSRH_USERNAME }}

      - if: failure() && github.event_name == 'push'
        name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          author_name: Failure in publishing SDK
          fields: repo,commit,author,action
          status: ${{ job.status }}

  publish-go-sdk:
    runs-on: ubuntu-latest
    name: publish-go-sdk
    needs: publish-provider
    permissions:
      id-token: write # For ESC secrets.
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          submodules: true

      - env:
          ESC_ACTION_ENVIRONMENT: github-secrets/${{ github.repository_owner }}-${{ github.event.repository.name }}
          ESC_ACTION_OIDC_AUTH: "true"
          ESC_ACTION_OIDC_ORGANIZATION: pulumi
          ESC_ACTION_OIDC_REQUESTED_TOKEN_TYPE: urn:pulumi:token-type:access_token:organization
        id: esc-secrets
        name: Fetch secrets from ESC
        uses: pulumi/esc-action@9eb774255b1a4afb7855678ae8d4a77359da0d9b

      - name: Install Languages & Frameworks
        uses: ./.github/actions/install

      - name: Checkout Go SDK repo
        uses: actions/checkout@v4
        with:
          token: ${{ steps.esc-secrets.outputs.PULUMI_BOT_TOKEN }}
          repository: pulumi/pulumi-azure-native-sdk
          path: sdk/pulumi-azure-native-sdk
          fetch-depth: 0

      - name: Checkout prerelease branch
        if: inputs.prerelease == true
        working-directory: sdk/pulumi-azure-native-sdk
        run: git checkout -b ${{ inputs.version }}

      - name: Checkout master branch
        if: inputs.prerelease == false
        working-directory: sdk/pulumi-azure-native-sdk
        run: git checkout master

      - name: Clear all source files
        working-directory: sdk/pulumi-azure-native-sdk
        run: find . -maxdepth 1 -not -name '.*' -exec rm -rf {} \;

      - name: Download Go SDK artifact
        uses: actions/download-artifact@v4
        with:
          name: pulumi-azure-native-sdk.tar.gz
          path: ${{ github.workspace}}/sdk/

      - name: UnTar Go SDK artifact
        run: |
          mkdir -p ${{github.workspace}}/sdk/pulumi-azure-native-sdk
          tar -zxf ${{ github.workspace}}/sdk/pulumi-azure-native-sdk.tar.gz -C ${{github.workspace}}/sdk/pulumi-azure-native-sdk

      - name: Prepare for publishing
        run: make prepublish_go

      - name: Commit
        working-directory: sdk/pulumi-azure-native-sdk
        run: |
          git config user.name "Pulumi Bot"
          git config user.email "bot@pulumi.com"
          git add .
          git commit -m "v${{ inputs.version }}"

      - name: Tag
        if: inputs.prerelease == false
        working-directory: sdk/pulumi-azure-native-sdk
        run: |
          ../../.github/scripts/tag-go-modules.sh ${{ inputs.version }}

      - name: Publish to prerelease branch
        if: inputs.prerelease == true
        working-directory: sdk/pulumi-azure-native-sdk
        run: git push -u origin ${{ inputs.version }} --tags

      - name: Publish to master branch
        if: inputs.prerelease == false
        working-directory: sdk/pulumi-azure-native-sdk
        run: git push -u origin master --tags

      - if: failure() && github.event_name == 'push'
        name: Notify Slack
        uses: 8398a7/action-slack@v3
        with:
          author_name: Failure in publishing SDK
          fields: repo,commit,author,action
          status: ${{ job.status }}
