name: release

on:
  push:
    tags:
      - v*.*.*

jobs:
  build_test:
    uses: ./.github/workflows/build-test.yml
    secrets: inherit
    with:
      ref: ${{ github.ref }}
      version: ${{ github.ref_name }}

  publish:
    uses: ./.github/workflows/publish.yml
    secrets: inherit
    needs: build_test
    with:
      ref: ${{ github.ref }}
      version: ${{ github.ref_name }}
      prerelease: ${{ contains(github.ref_name,'-') }}

  dispatch_docs_build:
    runs-on: ubuntu-latest
    needs: 
      - publish-sdks
      - publish
    if: contains(github.ref_name,'-')
    steps:
      - name: Install pulumictl
        uses: jaxxstorm/action-install-gh-release@v1.9.0
        with:
          repo: pulumi/pulumictl
      - name: Dispatch Event
        run: pulumictl create docs-build pulumi-azure-native ${GITHUB_REF#refs/tags/}
        env:
          GITHUB_TOKEN: ${{ secrets.PULUMI_BOT_TOKEN }}
    name: dispatch_docs_build
