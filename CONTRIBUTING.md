# Contributing to the Azure native provider

## Building

### Dependencies

- Go 1.15
- NodeJS 10.X.X or later
- Python 3.6 or later
- .NET Core 3.1
- Gradle 7.0.2 or later

Please refer to [Contributing to Pulumi](https://github.com/pulumi/pulumi/blob/master/CONTRIBUTING.md) for installation
guidance.

### Building locally

Run the following commands to install Go modules, generate all SDKs, and build the provider:

```bash
make ensure
make build
```

Note: When building via make, go workspaces are ignored.

### Running a nodejs example

Navigate to one of the `examples` and run Pulumi:

```bash
make install
cd ./examples/simple
yarn link @pulumi/azure-native
pulumi up
```

## Azure Versions

Key facts about Azure Versions:

- Azure's REST API has many versions of each service which are published per-service on their own schedule.
- Service versions are in the form of an ISO date (e.g. `2020-01-01`) followed by an optional suffix (e.g. `-preview` or `-privatepreview`).
- Not all versions of the service contain all resources. Some services will only publish the parts of their API which have changed since the previous version.
- Some services haven't had a stable (non-suffixed) release for a number of years - and the 'preview' versions are generally considered stable for every-day use.
- New specification versions are sometimes release before the updated service is deployed.

### Terminology

Azure's API specifications are organised into "Resource Providers" (or "Services"), Namespaces and API Versions. We use the term **"API Version"** in this doc to refer to Azure's Resource Provider API Versions.

### Version Sources

1. `spec.json`: the `azure-rest-api-specs` are checked out as a sub-module and include all OpenAPI specifications (for every Resource Provider API Version). The `spec.json` is a simplified report of versions in the spec - each version and the resources within.
2. `active.json` lists the 'active' API versions - the versions of each API which are actually deployed into Azure's data centers. It is generated by running `az provider list`, stripping excess information (which is written to `provider_list.json`) then gets summarised into `active.json`.

### Default Version Locks

The default version is calculated and written to a 'lock' file which list every resource (or invoke) at a specific API version. This file is read in during the schema and SDK generation. Currently there is a `v1-lock.json` and `v2-lock.json` lock file. These lock files should not be edited directly, but should be calculated by the versioner tool using a specific algorithm.

### Additional Reports

- `deprecated.json` is a list of API versions which are older than the versions included in the default version **and** at least 2 years old. These will be removed in the next major version of the provider.
- `pending.json` is a list of new API versions which aren't yet included in the default version. These should be included in the default version at the next major release of the provider.

### Default Versions

To provide simpler discovery and usability, the Pulumi Azure Native provider adds a single 'default' version for each API which is the combination of one or more API versions. The aim is to include all resources, at the latest available version, where possible.

Originally the default version was recalculated every time a new API version was released. This led to frequent breaking changes which had to be fixed before release of an update.

Now, we aim to specify more precisely the versions to combine into the 'default version' to avoid SDK instability.

For v1, the spec has been maintained manually in the [`v1-spec.yaml`](./versions/v1-spec.yaml). For v2 we've introduced the [`v2-config.yaml`](./versions/v2-config.yaml) which defines rules to automatically build and update the [`v2-spec.yaml`](./versions/v2-spec.yaml).

The config file performs three functions for each service:

1. Control which versions will be considered for the spec.
2. Assert expected properties of the spec - raising warnings when not met.
3. Document information relevant to the selection of versions and resources.

A spec file consists of service names, each specifying:

- `tracking` specifies a single version of the API to fetch all resources from.
- `additions` specified a map of specific resource (or invoke) name to API version to include in the default version.

Both `tracking` and `additions` can be specified together but if the set of resources overlaps (the same resource exists) in both the tracking version and the additions, then the versioning program will fail with an error.

From the spec YAML file, we can generate a version 'lock' JSON file ([`v1-lock.json`](./versions/v1-lock.json) and [`v2-lock.json`](./versions/v2-lock.json)) which contain the fully expanded set of default resources. These are the files used at the point of generating the schema.

To re-calculate the default version selection, run `make schema`.

### Type Compatibility

Supporting every version of every API causes the SDK size to be very large. One method we've used to reduce the required size is to only have a single set of types for each API which are re-used across all versions. However, not all the types are compatible and therefore a type with the same name might be incompatible in the next version. This incompatibility is currently detected but ignored on a case-by-case basis for now.

Ideally, at the point a new incompatible version of the type is added, it should then be created with a unique, stable name. Alternatively, we could create a union of the two possible types

## New Go SDK

As the size of the Go SDK is close to exceeding the limit of 512Mb, we've created a new SDK which we're publishing in parallel which defined a Go module per Azure namespace rather than a single root Go module. The additional go modules are auto-generated with the required dependencies in [provider/cmd/pulumi-gen-azure-native/main.go](./provider/cmd/pulumi-gen-azure-native/main.go#L312).

This new SDK is published to its own repository at [github.com/pulumi/pulumi-azure-native-sdk](https://github.com/pulumi/pulumi-azure-native-sdk). This is separate partly due to the large number of tags which are created in this new repository per release, but also to remove the need to commit the SDK code into this repository.
